<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON 极速格式化 - OpenHub</title>
    <meta name="description" content="极速 JSON 格式化、验证与压缩工具。支持大文件处理、层级折叠、Unicode/中文互转。">
    <link rel="icon" type="image/svg+xml" href="../../favicon.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* JSON Tree View Styles */
        .json-tree { font-size: 14px; line-height: 1.5; }
        .json-key { color: #8b5cf6; } /* violet-500 */
        .json-string { color: #10b981; } /* emerald-500 */
        .json-number { color: #f59e0b; } /* amber-500 */
        .json-boolean { color: #ef4444; } /* red-500 */
        .json-null { color: #9ca3af; } /* gray-400 */
        
        .collapsible { cursor: pointer; user-select: none; position: relative; padding-left: 1.2em; }
        .collapsible::before {
            content: '▼';
            position: absolute;
            left: 0;
            top: 0;
            font-size: 0.8em;
            color: #94a3b8;
            transition: transform 0.2s;
        }
        .collapsible.collapsed::before { transform: rotate(-90deg); }
        .collapsible.collapsed + .children { display: none; }
        
        .json-bracket { color: #64748b; font-weight: bold; }
    </style>
</head>
<body class="bg-gray-50 h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-white border-b border-gray-200 z-10 shrink-0">
        <div class="px-4 sm:px-6 lg:px-8 h-14 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <a href="../../index.html" class="flex items-center gap-2 hover:opacity-80 transition-opacity">
                    <div class="w-7 h-7 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-md flex items-center justify-center text-white font-bold shadow-sm text-sm">
                        O
                    </div>
                    <span class="hidden sm:inline font-bold text-lg tracking-tight text-gray-900">OpenHub<span class="text-indigo-600">.icu</span></span>
                </a>
                <span class="text-gray-300 mx-2">/</span>
                <span class="text-gray-600 font-medium text-sm">JSON 工具箱</span>
            </div>
        </div>
    </header>

    <!-- Toolbar -->
    <div class="bg-white border-b border-gray-200 px-4 py-2 flex items-center gap-2 shrink-0 shadow-sm z-10 overflow-x-auto whitespace-nowrap">
        <div class="flex items-center gap-1 bg-gray-100 p-1 rounded-lg">
            <label class="cursor-pointer px-3 py-1.5 rounded-md text-sm font-medium text-gray-700 hover:bg-white hover:shadow-sm hover:text-indigo-600 transition-all flex items-center gap-1">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                <span>导入</span>
                <input type="file" id="fileInput" accept=".json,.txt" class="hidden">
            </label>
            <button onclick="downloadJSON()" class="px-3 py-1.5 rounded-md text-sm font-medium text-gray-700 hover:bg-white hover:shadow-sm hover:text-indigo-600 transition-all flex items-center gap-1">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                <span>下载</span>
            </button>
        </div>

        <div class="w-px h-6 bg-gray-300 mx-1 flex-shrink-0"></div>

        <div class="flex items-center gap-1 bg-gray-100 p-1 rounded-lg">
            <button onclick="formatJSON()" class="px-3 py-1.5 rounded-md text-sm font-medium text-gray-700 hover:bg-white hover:shadow-sm hover:text-indigo-600 transition-all">格式化</button>
            <button onclick="compressJSON()" class="px-3 py-1.5 rounded-md text-sm font-medium text-gray-700 hover:bg-white hover:shadow-sm hover:text-indigo-600 transition-all">压缩</button>
        </div>
        
        <div class="w-px h-6 bg-gray-300 mx-1 flex-shrink-0"></div>
        
        <div class="flex items-center gap-1 bg-gray-100 p-1 rounded-lg">
            <button onclick="toUnicode()" class="px-3 py-1.5 rounded-md text-sm font-medium text-gray-700 hover:bg-white hover:shadow-sm hover:text-indigo-600 transition-all">中文转 Unicode</button>
            <button onclick="toChinese()" class="px-3 py-1.5 rounded-md text-sm font-medium text-gray-700 hover:bg-white hover:shadow-sm hover:text-indigo-600 transition-all">Unicode 转中文</button>
        </div>

        <div class="w-px h-6 bg-gray-300 mx-1 flex-shrink-0"></div>

        <div class="flex items-center gap-1">
             <button onclick="toggleExpand(true)" class="p-1.5 rounded-md text-gray-500 hover:bg-gray-100 hover:text-indigo-600" title="全部展开">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 13l-7 7-7-7m14-8l-7 7-7-7"></path></svg>
            </button>
            <button onclick="toggleExpand(false)" class="p-1.5 rounded-md text-gray-500 hover:bg-gray-100 hover:text-indigo-600" title="全部折叠">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 11l7-7 7 7M5 19l7-7 7 7"></path></svg>
            </button>
             <button onclick="copyResult()" class="p-1.5 rounded-md text-gray-500 hover:bg-gray-100 hover:text-indigo-600" title="复制结果">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2"></path></svg>
            </button>
            <button onclick="clearAll()" class="p-1.5 rounded-md text-gray-500 hover:bg-gray-100 hover:text-red-600" title="清空">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
            </button>
        </div>
        
        <span id="statusMsg" class="ml-auto text-xs font-medium text-gray-500 px-2 py-1 rounded bg-gray-100 hidden"></span>
    </div>

    <!-- Main Split View -->
    <div class="flex-grow flex flex-col md:flex-row overflow-hidden relative">
        
        <!-- Left: Input -->
        <div class="flex-1 flex flex-col min-h-[50%] md:min-h-0 border-b md:border-b-0 md:border-r border-gray-200 relative group">
            <div class="absolute top-2 right-2 px-2 py-1 bg-gray-100 text-xs text-gray-500 rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">Input</div>
            
            <div class="flex-1 flex relative overflow-hidden">
                <!-- Line Numbers -->
                <div id="lineNumbers" class="w-12 bg-gray-50 border-r border-gray-100 text-right text-gray-400 py-4 pr-2 pl-1 font-mono text-sm leading-relaxed select-none overflow-hidden">
                    1
                </div>
                
                <!-- Input Area -->
                <textarea id="jsonInput" 
                    class="flex-1 h-full p-4 resize-none focus:outline-none focus:bg-indigo-50/10 font-mono text-sm leading-relaxed text-gray-800 bg-white border-none w-full" 
                    placeholder="在此粘贴 JSON 字符串..." 
                    spellcheck="false"></textarea>
            </div>
        </div>

        <!-- Right: Tree View / Output -->
        <div class="flex-1 flex flex-col min-h-[50%] md:min-h-0 bg-gray-50 relative group overflow-hidden">
            <div class="absolute top-2 right-2 px-2 py-1 bg-gray-100 text-xs text-gray-500 rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">Output</div>
            
            <!-- Viewer Container -->
            <div id="jsonViewer" class="w-full h-full p-4 overflow-auto font-mono text-sm leading-relaxed">
                <div class="text-gray-400 mt-10 text-center select-none">
                    <svg class="w-12 h-12 mx-auto mb-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path></svg>
                    <p>在左侧输入内容，结果将显示在这里</p>
                </div>
            </div>
            
            <!-- Error Overlay -->
            <div id="errorOverlay" class="absolute inset-0 bg-white/90 backdrop-blur-sm flex items-center justify-center hidden z-20">
                <div class="bg-red-50 border border-red-200 rounded-lg p-4 max-w-md shadow-lg">
                    <div class="flex items-center gap-2 text-red-700 font-bold mb-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        JSON 解析错误
                    </div>
                    <p id="errorMsg" class="text-sm text-red-600 font-mono break-all"></p>
                </div>
            </div>
        </div>

    </div>

    <script>
        const input = document.getElementById('jsonInput');
        const lineNumbers = document.getElementById('lineNumbers');
        const viewer = document.getElementById('jsonViewer');
        const errorOverlay = document.getElementById('errorOverlay');
        const errorMsg = document.getElementById('errorMsg');
        const statusMsg = document.getElementById('statusMsg');
        
        let currentJSON = null; // Store current parsed object
        let escapeUnicodeMode = false; // Control if we force escape unicode chars in Tree View

        // --- Core Logic ---

        // Auto format on paste? Maybe too aggressive. Let's do it on input with debounce
        let debounceTimer;
        input.addEventListener('input', () => {
            updateLineNumbers();
            
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                if (input.value.trim()) {
                    tryParseAndRender();
                } else {
                    viewer.innerHTML = '<div class="text-gray-400 mt-10 text-center select-none"><svg class="w-12 h-12 mx-auto mb-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path></svg><p>在左侧输入内容，结果将显示在这里</p></div>';
                    errorOverlay.classList.add('hidden');
                    currentJSON = null;
                }
            }, 500);
        });

        input.addEventListener('scroll', syncScroll);

        function tryParseAndRender() {
            const raw = input.value;
            if (!raw.trim()) return;

            try {
                // 1. Try Strict JSON first
                currentJSON = JSON.parse(raw);
                renderTree(currentJSON);
                errorOverlay.classList.add('hidden');
                showStatus('解析成功', 'text-green-600');
            } catch (eStrict) {
                // 2. Try Loose / Python JSON
                try {
                    // Python/JS compatible parsing
                    // Use new Function to parse loosely (supports single quotes, trailing commas, etc.)
                    // Inject Python literals: True, False, None
                    // We wrap in a block to allow variable injection without polluting global scope (though new Function is its own scope)
                    // We assign to a variable 'res' to handle expressions properly, then return it.
                    const looseParse = new Function('"use strict"; const True = true, False = false, None = null; const res = ' + raw + '\n; return res;');
                    currentJSON = looseParse();
                    
                    // Validate result type
                    if (currentJSON === undefined || typeof currentJSON === 'function' || typeof currentJSON === 'symbol') {
                        throw new Error('Invalid JSON data');
                    }
                    
                    renderTree(currentJSON);
                    errorOverlay.classList.add('hidden');
                    showStatus('解析成功 (兼容模式)', 'text-indigo-600');
                    
                } catch (eLoose) {
                    // If loose parse also fails, show the original strict error (usually more helpful)
                    showError(eStrict);
                }
            }
        }

        function showError(e) {
            const loc = getErrorLocation(e);
            let msg = e.message;
            if (loc) {
                msg += ` (Line ${loc.line}, Column ${loc.column})`;
                highlightErrorLine(loc.line);
                scrollToLine(loc.line);
            }
            errorMsg.textContent = msg;
            errorOverlay.classList.remove('hidden');
            showStatus('格式错误', 'text-red-500');
        }

        function showStatus(msg, colorClass) {
            statusMsg.textContent = msg;
            statusMsg.className = `ml-auto text-xs font-medium px-2 py-1 rounded bg-gray-100 ${colorClass}`;
            statusMsg.classList.remove('hidden');
            setTimeout(() => {
                statusMsg.classList.add('hidden');
            }, 3000);
        }

        // --- Tree Renderer ---
        
        function renderTree(data) {
            viewer.innerHTML = '';
            viewer.appendChild(createNode(data));
        }

        function createNode(data) {
            if (data === null) return createLeaf('null', 'null');
            if (typeof data === 'boolean') return createLeaf(data, 'boolean');
            if (typeof data === 'number') return createLeaf(data, 'number');
            if (typeof data === 'string') {
                let val = data;
                if (escapeUnicodeMode) {
                    val = val.replace(/[\u4e00-\u9fa5]/g, char => '\\u' + char.charCodeAt(0).toString(16));
                }
                return createLeaf(`"${escapeHtml(val)}"`, 'string');
            }
            
            if (Array.isArray(data)) {
                return createCollapsible('[', ']', data, (item) => createNode(item));
            }
            
            if (typeof data === 'object') {
                return createCollapsible('{', '}', Object.keys(data), (key) => {
                    const line = document.createElement('div');
                    line.className = 'flex';
                    const keySpan = document.createElement('span');
                    keySpan.className = 'json-key mr-1';
                    keySpan.textContent = `"${key}":`;
                    line.appendChild(keySpan);
                    line.appendChild(createNode(data[key]));
                    return line;
                });
            }
        }

        function createLeaf(val, type) {
            const span = document.createElement('span');
            span.className = `json-${type}`;
            span.textContent = val;
            return span;
        }

        function createCollapsible(openChar, closeChar, items, mapFn) {
            const container = document.createElement('div');
            container.className = 'inline-block align-top';
            
            const header = document.createElement('span');
            header.className = 'json-bracket';
            header.textContent = openChar;
            
            if (items.length === 0) {
                header.textContent += closeChar;
                container.appendChild(header);
                return container;
            }

            const collapsible = document.createElement('span');
            collapsible.className = 'collapsible ml-1';
            collapsible.addEventListener('click', function(e) {
                e.stopPropagation();
                this.classList.toggle('collapsed');
                // Toggle ellipsis?
                if (this.classList.contains('collapsed')) {
                    this.nextElementSibling.style.display = 'none';
                    suffix.textContent = ` ... ${closeChar} // ${items.length} items`;
                } else {
                    this.nextElementSibling.style.display = 'block';
                    suffix.textContent = closeChar;
                }
            });
            
            container.appendChild(header);
            container.appendChild(collapsible);

            const childrenDiv = document.createElement('div');
            childrenDiv.className = 'children pl-6 border-l border-gray-200 ml-1';
            
            items.forEach((item, index) => {
                const childNode = mapFn(item);
                const wrapper = document.createElement('div');
                wrapper.className = 'flex items-start'; // Align items to top, but flex row keeps comma next to content
                wrapper.appendChild(childNode);
                if (index < items.length - 1) {
                    const comma = document.createElement('span');
                    comma.textContent = ',';
                    comma.className = 'text-gray-400';
                    wrapper.appendChild(comma);
                }
                childrenDiv.appendChild(wrapper);
            });

            container.appendChild(childrenDiv);
            
            const suffix = document.createElement('span');
            suffix.className = 'json-bracket';
            suffix.textContent = closeChar;
            container.appendChild(suffix);

            return container;
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }


        // --- Actions ---

        function formatJSON() {
            if (!currentJSON && input.value) tryParseAndRender();
            if (currentJSON) {
                input.value = JSON.stringify(currentJSON, null, 2);
                renderTree(currentJSON); // Re-render to reset collapsed states or just sync
                showStatus('已格式化', 'text-indigo-600');
            }
        }

        function compressJSON() {
            if (!currentJSON && input.value) tryParseAndRender();
            if (currentJSON) {
                const compressed = JSON.stringify(currentJSON);
                input.value = compressed;
                // We keep the tree view as is (formatted), or update it?
                // Tree view is always structured.
                showStatus('已压缩', 'text-indigo-600');
            }
        }

        function toUnicode() {
            const val = input.value;
            if (!val) return;
            const result = val.replace(/[\u4e00-\u9fa5]/g, char => '\\u' + char.charCodeAt(0).toString(16));
            input.value = result;
            
            // Set mode and render
            escapeUnicodeMode = true;
            tryParseAndRender();
            
            showStatus('中文转 Unicode 完成', 'text-indigo-600');
        }

        function toChinese() {
            const val = input.value;
            if (!val) return;
            // Handle \uXXXX (case insensitive)
            const result = val.replace(/\\u[\dA-F]{4}/gi, match => 
                String.fromCharCode(parseInt(match.replace(/\\u/ig, ''), 16))
            );
            input.value = result;
            
            // Set mode and render
            escapeUnicodeMode = false;
            tryParseAndRender();
            
            showStatus('Unicode 转中文 完成', 'text-indigo-600');
        }
        
        function clearAll() {
            input.value = '';
            viewer.innerHTML = '<div class="text-gray-400 mt-10 text-center select-none"><svg class="w-12 h-12 mx-auto mb-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path></svg><p>在左侧输入内容，结果将显示在这里</p></div>';
            currentJSON = null;
            errorOverlay.classList.add('hidden');
        }

        function copyResult() {
            // Copy what? The formatted tree text or the input value?
            // Usually user wants the formatted JSON if they clicked format, or compressed if compressed.
            // Let's copy whatever is in the input box, assuming that's the "source of truth"
            // OR if we want to support copying the Tree View text, that's hard.
            
            if (input.value) {
                navigator.clipboard.writeText(input.value).then(() => {
                    showStatus('已复制到剪贴板', 'text-green-600');
                });
            }
        }

        // --- Line Numbers & Sync Scroll ---

        function updateLineNumbers() {
            const lines = input.value.split('\n').length;
            let html = '';
            for (let i = 1; i <= lines; i++) {
                html += `<div id="line-${i}">${i}</div>`;
            }
            lineNumbers.innerHTML = html;
        }

        function syncScroll() {
            lineNumbers.scrollTop = input.scrollTop;
        }

        function getErrorLocation(e) {
            // Firefox
            if (typeof e.lineNumber !== 'undefined' && typeof e.columnNumber !== 'undefined') {
                return { line: e.lineNumber, column: e.columnNumber };
            }
            
            // Chrome / V8 / Node
            const match = e.message.match(/at position (\d+)/);
            if (match) {
                const pos = parseInt(match[1], 10);
                const val = input.value;
                let line = 1;
                let col = 1;
                for (let i = 0; i < pos && i < val.length; i++) {
                    if (val[i] === '\n') {
                        line++;
                        col = 1;
                    } else {
                        col++;
                    }
                }
                return { line, column: col };
            }
            return null;
        }

        function highlightErrorLine(line) {
            const lineDiv = document.getElementById(`line-${line}`);
            if (lineDiv) {
                lineDiv.className = 'bg-red-200 text-red-600 font-bold rounded px-1 -mx-1';
            }
        }

        function scrollToLine(line) {
             const lineDiv = document.getElementById(`line-${line}`);
             if (lineDiv) {
                 const targetTop = lineDiv.offsetTop - (input.clientHeight / 2) + (lineDiv.clientHeight / 2);
                 input.scrollTo({ top: targetTop, behavior: 'smooth' });
             }
        }
        
        // Initialize
        updateLineNumbers();
        
        function downloadJSON() {
            if (!input.value) return;
            const blob = new Blob([input.value], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'data.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function toggleExpand(expand) {
            const collapsibles = document.querySelectorAll('.collapsible');
            collapsibles.forEach(el => {
                const isCollapsed = el.classList.contains('collapsed');
                if (expand && isCollapsed) {
                    el.click();
                } else if (!expand && !isCollapsed) {
                    el.click();
                }
            });
        }

        // --- File Upload ---
        const fileInput = document.getElementById('fileInput');
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            // Limit size? 
            if (file.size > 10 * 1024 * 1024) {
                if(!confirm('文件较大 (' + (file.size/1024/1024).toFixed(1) + 'MB)，处理可能需要一点时间，是否继续？')) {
                    fileInput.value = '';
                    return;
                }
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                input.value = e.target.result;
                tryParseAndRender();
                showStatus('文件导入成功', 'text-indigo-600');
            };
            reader.readAsText(file);
            fileInput.value = ''; // Reset
        });

    </script>
</body>
</html>