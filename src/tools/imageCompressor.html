<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图片极速压缩 - OpenHub</title>
    <meta name="description" content="基于浏览器本地的图片压缩工具，无隐私风险。支持 WebP 转换，实时预览压缩效果。">
    <script src="https://cdn.tailwindcss.com/3.4.17"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Custom Range Slider */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #4f46e5;
            cursor: pointer;
            margin-top: -6px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #e2e8f0;
            border-radius: 2px;
        }
        .checkered-bg {
            background-image: linear-gradient(45deg, #f1f5f9 25%, transparent 25%), 
                              linear-gradient(-45deg, #f1f5f9 25%, transparent 25%), 
                              linear-gradient(45deg, transparent 75%, #f1f5f9 75%), 
                              linear-gradient(-45deg, transparent 75%, #f1f5f9 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }
    </style>
</head>
<body class="h-screen flex flex-col bg-gray-50 text-gray-900">

    <!-- Header -->
    <header class="bg-white border-b border-gray-200 z-10 shrink-0">
        <div class="px-4 sm:px-6 lg:px-8 h-14 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <a href="../../index.html" class="flex items-center gap-2 hover:opacity-80 transition-opacity">
                    <div class="w-7 h-7 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-md flex items-center justify-center text-white font-bold shadow-sm text-sm">
                        O
                    </div>
                    <span class="hidden sm:inline font-bold text-lg tracking-tight text-gray-900">OpenHub<span class="text-indigo-600">.icu</span></span>
                </a>
                <span class="text-gray-300 mx-2">/</span>
                <span class="text-gray-600 font-medium text-sm">图片极速压缩</span>
            </div>
        </div>
    </header>

    <!-- Toolbar -->
    <div id="toolbar" class="bg-white border-b border-gray-200 px-6 py-3 flex items-center gap-6 shrink-0 z-20 hidden">
        <button onclick="document.getElementById('fileInput').click()" class="flex items-center gap-2 px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-700 text-xs font-medium rounded-md transition-colors whitespace-nowrap">
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
            重选
        </button>

        <div class="h-6 w-px bg-gray-200"></div>

        <div class="flex items-center gap-3 w-64 transition-opacity" id="qualityControl">
            <span class="text-xs font-medium text-gray-500 uppercase">质量</span>
            <input type="range" id="quality" min="0.1" max="1.0" step="0.05" value="0.7" class="flex-1">
            <span id="qualityValue" class="text-sm font-mono text-gray-700 w-8 text-right">80%</span>
        </div>
        
        <div class="h-6 w-px bg-gray-200"></div>

        <div class="flex items-center gap-3">
            <span class="text-xs font-medium text-gray-500 uppercase">格式</span>
            <select id="format" class="text-sm border-gray-300 border rounded-md px-2 py-1 focus:border-indigo-500 focus:ring-indigo-500">
                <option value="image/jpeg" selected>JPEG</option>
                <option value="image/png">PNG</option>
                <option value="image/webp">WebP (推荐)</option>
                <option value="original">保持原格式</option>
            </select>
        </div>

        <div class="h-6 w-px bg-gray-200"></div>

        <div class="flex items-center gap-3">
            <span class="text-xs font-medium text-gray-500 uppercase">最大宽度</span>
            <input type="number" id="maxWidth" placeholder="自动" class="text-sm border-gray-300 border rounded-md px-2 py-1 w-20 focus:border-indigo-500 focus:ring-indigo-500">
        </div>
    </div>

    <!-- Main Content -->
    <main class="flex-1 relative flex flex-col">
        
        <!-- Empty State / Drop Zone -->
        <div id="dropZone" class="absolute inset-0 z-10 flex flex-col items-center justify-center p-8 transition-colors bg-gray-50/50">
            <input type="file" id="fileInput" accept="image/*" class="hidden">
            <div class="max-w-md w-full border-2 border-dashed border-gray-300 rounded-2xl p-10 flex flex-col items-center justify-center text-center bg-white shadow-sm hover:border-indigo-400 hover:bg-indigo-50/10 transition-all cursor-pointer group" onclick="document.getElementById('fileInput').click()">
                <div class="w-16 h-16 bg-indigo-50 rounded-2xl flex items-center justify-center text-indigo-500 mb-6 group-hover:scale-110 transition-transform duration-300">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                </div>
                <h3 class="text-xl font-bold text-gray-900 mb-2">点击或拖拽上传图片</h3>
                <p class="text-gray-500 text-sm mb-6">支持 JPG, PNG, WebP 等常见格式<br>所有处理均在本地浏览器完成，绝不上传服务器</p>
                <button class="px-5 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-medium rounded-lg shadow-sm transition-all hover:shadow-md">选择文件</button>
            </div>
        </div>

        <!-- Editor View (Hidden by default) -->
        <div id="editorView" class="flex-1 grid grid-cols-2 h-full hidden">
            <!-- Original -->
            <div class="border-r border-gray-200 flex flex-col bg-white">
                <div class="px-4 py-2 border-b border-gray-100 flex justify-between items-center bg-gray-50 h-12 shrink-0">
                    <span class="text-xs font-semibold text-gray-500 uppercase tracking-wider">原始图片</span>
                    <span id="originalSize" class="text-xs font-mono font-medium text-gray-700 bg-gray-200 px-2 py-0.5 rounded">-- KB</span>
                </div>
                <div class="flex-1 overflow-auto bg-gray-50/50 relative">
                    <div class="min-h-full w-full flex p-4 checkered-bg">
                        <img id="originalImage" class="max-w-full m-auto shadow-lg rounded-lg" src="" alt="Original">
                    </div>
                </div>
            </div>

            <!-- Compressed -->
            <div class="flex flex-col bg-white">
                <div class="px-4 py-2 border-b border-gray-100 flex justify-between items-center bg-gray-50 h-12 shrink-0">
                    <div class="flex items-center gap-3">
                        <span class="text-xs font-semibold text-gray-500 uppercase tracking-wider">压缩预览</span>
                        <span id="savingsBadge" class="text-xs font-bold text-green-600 bg-green-100 px-2 py-0.5 rounded hidden" title="">-0%</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <span id="compressedSize" class="text-xs font-mono font-medium text-gray-700 bg-gray-200 px-2 py-1 rounded">-- KB</span>
                        <button id="downloadBtn" class="flex items-center gap-1.5 px-3 py-1.5 bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-medium rounded-md shadow-sm transition-all transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            <span>下载</span>
                        </button>
                    </div>
                </div>
                <div class="flex-1 overflow-auto bg-white relative">
                    <div class="min-h-full w-full flex p-4 bg-[url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAADFJREFUOE9jZGBgEGHADz7A+EwM/5G1w8QxLOKjYQzD4A8YJg8aBmFwGgZhcBoGIXAaBgF8EigNn2/2AAAAAElFTkSuQmCC')]">
                        <img id="compressedImage" class="max-w-full m-auto shadow-sm" alt="Compressed preview">
                    </div>
                    <!-- Loading Overlay -->
                    <div id="loadingOverlay" class="absolute inset-0 bg-white/80 flex items-center justify-center z-10 hidden">
                        <svg class="animate-spin h-8 w-8 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Elements
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const editorView = document.getElementById('editorView');
        const toolbar = document.getElementById('toolbar');
        
        const originalImage = document.getElementById('originalImage');
        const compressedImage = document.getElementById('compressedImage');
        const originalSize = document.getElementById('originalSize');
        const compressedSize = document.getElementById('compressedSize');
        const savingsBadge = document.getElementById('savingsBadge');
        const downloadBtn = document.getElementById('downloadBtn');
        const loadingOverlay = document.getElementById('loadingOverlay');

        const qualityInput = document.getElementById('quality');
        const qualityValue = document.getElementById('qualityValue');
        const qualityControl = document.getElementById('qualityControl');
        const formatInput = document.getElementById('format');
        const maxWidthInput = document.getElementById('maxWidth');

        // State
        let currentFile = null;
        let originalBlob = null;
        let compressedBlob = null;

        // Event Listeners
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('bg-indigo-50/80', 'border-indigo-300');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('bg-indigo-50/80', 'border-indigo-300');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('bg-indigo-50/80', 'border-indigo-300');
            const files = e.dataTransfer.files;
            if (files.length > 0) handleFile(files[0]);
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) handleFile(e.target.files[0]);
        });

        qualityInput.addEventListener('input', (e) => {
            qualityValue.textContent = Math.round(e.target.value * 100) + '%';
            debounceCompress();
        });

        formatInput.addEventListener('change', () => {
            updateQualityState();
            compressImage();
        });
        maxWidthInput.addEventListener('change', () => compressImage());

        downloadBtn.addEventListener('click', () => {
            if (!compressedBlob) return;
            const url = URL.createObjectURL(compressedBlob);
            const a = document.createElement('a');
            a.href = url;
            
            // Generate filename
            const originalName = currentFile.name;
            const ext = compressedBlob.type.split('/')[1];
            const namePart = originalName.substring(0, originalName.lastIndexOf('.')) || originalName;
            a.download = `${namePart}_min.${ext}`;
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        // Helper Functions
        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                alert('请上传图片文件');
                return;
            }
            currentFile = file;
            originalBlob = file;
            
            // UI Update
            dropZone.classList.add('hidden');
            editorView.classList.remove('hidden');
            toolbar.classList.remove('hidden');
            
            // Display Original
            const url = URL.createObjectURL(file);
            originalImage.src = url;
            originalSize.textContent = formatBytes(file.size);

            // Initial Compress
            updateQualityState();
            compressImage();
        }

        function updateQualityState() {
            let mimeType = formatInput.value;
            if (mimeType === 'original' && currentFile) mimeType = currentFile.type;
            
            const isPng = mimeType === 'image/png';
            qualityInput.disabled = isPng;
            if (isPng) {
                qualityControl.classList.add('opacity-50', 'cursor-not-allowed');
                qualityValue.textContent = 'N/A';
                qualityInput.title = "PNG 格式为无损压缩，不支持质量调整";
            } else {
                qualityControl.classList.remove('opacity-50', 'cursor-not-allowed');
                qualityValue.textContent = Math.round(qualityInput.value * 100) + '%';
                qualityInput.title = "";
            }
        }

        let debounceTimer;
        function debounceCompress() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(compressImage, 300);
        }

        function compressImage() {
            if (!currentFile) return;

            loadingOverlay.classList.remove('hidden');
            
            const img = new Image();
            img.src = URL.createObjectURL(currentFile);
            
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;
                
                // Resize logic
                const maxWidth = parseInt(maxWidthInput.value);
                if (maxWidth && width > maxWidth) {
                    const ratio = maxWidth / width;
                    width = maxWidth;
                    height = height * ratio;
                }

                canvas.width = width;
                canvas.height = height;
                
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);

                // Determine format
                let mimeType = formatInput.value;
                if (mimeType === 'original') mimeType = currentFile.type;
                if (!['image/jpeg', 'image/png', 'image/webp'].includes(mimeType)) {
                     if(mimeType === 'image/svg+xml') mimeType = 'image/png';
                }

                const quality = parseFloat(qualityInput.value);

                canvas.toBlob((blob) => {
                    if (!blob) {
                        alert('压缩失败');
                        loadingOverlay.classList.add('hidden');
                        return;
                    }
                    
                    compressedBlob = blob;
                    const url = URL.createObjectURL(blob);
                    compressedImage.src = url;
                    
                    // Stats
                    compressedSize.textContent = formatBytes(blob.size);
                    const savings = ((originalBlob.size - blob.size) / originalBlob.size * 100);
                    
                    if (savings > 0) {
                        savingsBadge.textContent = `节省 ${savings.toFixed(1)}%`;
                        savingsBadge.className = "text-xs font-bold text-green-600 bg-green-100 px-2 py-0.5 rounded";
                        savingsBadge.classList.remove('hidden');
                    } else {
                        savingsBadge.textContent = `体积增加 ${Math.abs(savings).toFixed(1)}%`;
                        savingsBadge.className = "text-xs font-bold text-orange-600 bg-orange-100 px-2 py-0.5 rounded cursor-help";
                        savingsBadge.title = "PNG 为无损格式，浏览器重新编码可能导致体积增加。建议使用 WebP 格式。";
                        savingsBadge.classList.remove('hidden');
                    }

                    loadingOverlay.classList.add('hidden');
                }, mimeType, quality);
            };
        }
    </script>
</body>
</html>